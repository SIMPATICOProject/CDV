<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Service Editor</title>

    <!-- Bootstrap -->
    <link href="vendors/bootstrap/distrib/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- NProgress -->
<!--     <link href="../vendors/nprogress/nprogress.css" rel="stylesheet"> -->

    <!-- iCheck -->
    <link href="vendors/iCheck/skins/flat/green.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <!-- Custom Theme Style -->
    <link href="css/custom.min.css" rel="stylesheet">
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor/dist/jsoneditor.min.js"></script>
    
    <script>
    // Set the default CSS theme and icon library globally
    JSONEditor.defaults.theme = 'bootstrap3';
    JSONEditor.defaults.iconlib = 'fontawesome4';
    var schemaDir = "json/service-entry.json";
    </script>

  </head>
  <style>
  	input[type="text"]{
  		height: auto !important;
  	} 
  </style>
  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0;">
              <a href="index.html" class="site_title"><i class="fa fa-users"></i> <span>CDV Dashboard</span></a>
            </div>

            <div class="clearfix"></div>
            <br />

<!-- sidebar menu -->
            <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
              <div class="menu_section">
                <h3>Menu</h3>
                <ul class="nav side-menu">
                  <li><a><i class="fa fa-edit"></i> Services <span class="fa fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="index.html">Available Services</a></li>
                      <li><a href="edit-service.html">Add New Service</a></li>
                    </ul>
                  </li>
                  
                </ul>
              </div>

            </div>
<!-- /sidebar menu -->

          </div>
        </div>

<!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <nav>
              <div class="nav toggle" style="padding-bottom: 15px !important">
                <a id="menu_toggle"><i class="fa fa-bars"></i></a>
              </div>
              <ul class="nav navbar-nav navbar-right">
              </ul>
            </nav>
          </div>
        </div>
<!-- /top navigation -->

<!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h1>CDV Service Editor</h1>
              </div>
            </div>

            <div class="clearfix"></div>

            <div class="row">
            
	            <div class="col-md-12 col-sm-12 col-xs-12">
	                <div class="x_panel">
            
				      <div class="medium-6 columns" style="padding-top:1em;padding-bottom:1em">
				        <button id="submit" class="btn btn-success">Update Service</button>
				        <button id="restore" class="btn btn-warning">Restore to Default</button>
				        <!-- <span id="valid_indicator" class="label success">valid</span> -->
				      </div>

				    <div class="row"style="margin-left:auto;margin-right:auto">
				      <div id="editor_holder" class="medium-12 columns">
				      </div>
				    </div>
	 
	            </div>
          </div>
       </div>
     </div>

<!-- /page content -->

<!-- footer content -->
        <footer>
          <div class="pull-right">
            CDV Service Editor
          </div>
          <div class="clearfix"></div>
        </footer>
<!-- /footer content -->
      </div>
    </div>

    <!-- jQuery -->
    <script src="vendors/jquery/distrib/jquery.min.js"></script>
    <script>
    	//Caricamento sequenziale dei rimanenti script per garanzia funzionamento globale
    	$.getScript("vendors/bootstrap/distrib/js/bootstrap.min.js",function() {
    		$.getScript("vendors/fastclick/lib_dir/fastclick.js", function(){
    			//$.getScript("vendors/nprogress/nprogress.js");
    			$.getScript("vendors/iCheck/icheck.min.js", function(){
    				$.getScript("vendors/datatables.net/js/jquery.dataTables.js", function(){
    					$.getScript("vendors/datatables.net-bs/js/dataTables.bootstrap.min.js", function(){
    						$.getScript("vendors/datatables.net-buttons/js/dataTables.buttons.min.js", function(){
    							$.getScript("vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js", function(){
    								$.getScript("vendors/datatables.net-buttons/js/buttons.flash.min.js", function(){
    									$.getScript("vendors/datatables.net-buttons/js/buttons.html5.min.js", function(){
    										$.getScript("vendors/datatables.net-buttons/js/buttons.print.min.js", function(){
    											$.getScript("vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js", function(){
    												$.getScript("vendors/datatables.net-keytable/js/dataTables.keyTable.min.js", function(){
    													$.getScript("vendors/datatables.net-responsive/js/dataTables.responsive.min.js", function(){
    														$.getScript("vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js", function(){
    															$.getScript("vendors/datatables.net-scroller/js/dataTables.scroller.js", function(){
    																$.getScript("vendors/jszip/distrib/jszip.min.js", function(){
    																	//$.getScript("vendors/pdfmake/build_dir/pdfmake.min.js");
    															    	$.getScript("vendors/pdfmake/build_dir/vfs_fonts.js", function(){
    															    		$.getScript("js/custom.min.js");
    															    	})
    																})
    															})
    														})
    													})
    												})
    											})
    										})
    									})
    								})
    							})
    						})
    					})
    				})
    			})
    		})
    	})

	    function CreateNewService(){
	    	window.location.href = window.location.href+"index.html";
	    };
	    
	</script>
	<script src="vendors/pdfmake/build_dir/pdfmake.min.js"></script>

  </body>
  <script>
    var serviceID=window.location.href;
    var start = serviceID.indexOf("&");
    
    //PUT - UPDATE SELECTED SERVICE
    if(start != -1){
    	
	    var len = serviceID.length - start - 1;
	    serviceID = serviceID.substr(start+1, len);
	    //console.log("id servizio estratto da path: "+serviceID);
		var starting_value="{}"
		$(function() {
	        $.get( "http://localhost:8080/service-manager/api/v1/services/"+serviceID, function( data ) {
	          starting_value=data;
		      // Initialize the editor
		      var editor = new JSONEditor(document.getElementById('editor_holder'),{
		        // Enable fetching schemas via ajax
		        ajax: true,
		        
		        // The schema for the editor
		        schema: {
		          $ref: schemaDir/*,
		          format: "grid"*/ //no tab version
		        },
		        
		        // Seed the form with a starting value
		        startval: starting_value
		      });
		      
		      // Hook up the submit button to log to the console
		      document.getElementById('submit').addEventListener('click',function() {
	
		    	if (confirm('Il servizio verrà modificato, sei sicuro di voler procedere?')){
		    		//PUT
			        $.ajax({
				        url: "http://localhost:8080/service-manager/api/v1/services/"+serviceID,
				        method: 'PUT',
				        contentType: "application/json",
				        data: JSON.stringify(editor.getValue()),
				    }).then(function() {
				    	 //location.reload();
				    	 //console.log("yuri: "+window.location.origin+"/service-editor/index.html");
				    	 window.location.href = window.location.origin+"/service-editor/index.html";
				    });
		    	}
		      });
		      
		      // Hook up the Restore to Default button
		      document.getElementById('restore').addEventListener('click',function() {
		        editor.setValue(starting_value);
		      });
		      
		      // Hook up the validation indicator to update its status whenever the editor changes
		      editor.on('change',function() {
		        // Get an array of errors from the validator
		        var errors = editor.validate();
		        var indicator = document.getElementById('valid_indicator');
		        
		        // Not valid
		        if(errors.length) {
		          indicator.className = 'label alert';
		          indicator.textContent = 'not valid';
		        }
		        // Valid
		        else {
		          indicator.className = 'label success';
		          indicator.textContent = 'valid';
		        }
		      });
	        });
		  });
    }
    //POST - ADDING NEW SERVICE
    else{
    	  $('#submit').text("Create Service");
	      // Initialize the editor
	      var editor = new JSONEditor(document.getElementById('editor_holder'),{
	        // Enable fetching schemas via ajax
	        ajax: true,
	        // The schema for the editor
	        schema: {
	          $ref: schemaDir/*,
	          format: "grid"*/ //no tab version
	        }
	      });
	      
	      // Hook up the submit button to log to the console
	      document.getElementById('submit').addEventListener('click',function() {

	    	if (confirm( 'Il servizio verrà creato, sei sicuro di voler procedere?')){    		
	    		//POST
		        $.ajax({
			        url: "http://localhost:8080/service-manager/api/v1/services/",
			        method: 'POST',
			        contentType: "application/json",
			        data: JSON.stringify(editor.getValue()),
			        //success: function() {location.reload();}
			    }).then(function() {
			    	window.location.href = window.location.origin+"/service-editor/";
			    });
	    	}
	      });
	      
	      // Hook up the Restore to Default button
	      document.getElementById('restore').addEventListener('click',function() {
	        editor.setValue(starting_value);
	      });
	      
	   	  // Hook up the Home button
	      document.getElementById('home').addEventListener('click',function() {
	    	  window.location.href = window.location.origin+"/service-editor/index.html";//window.location.origin+"/service-editor/";
	      });
	      
	      // Hook up the validation indicator to update its status whenever the editor changes
	      editor.on('change',function() {
	        // Get an array of errors from the validator
	        var errors = editor.validate();
	        
	        var indicator = document.getElementById('valid_indicator');
	        
	        // Not valid
	        if(errors.length) {
	          indicator.className = 'label alert';
	          indicator.textContent = 'not valid';
	        }
	        // Valid
	        else {
	          indicator.className = 'label success';
	          indicator.textContent = 'valid';
	        }
	      });
    }
  </script>
</html>